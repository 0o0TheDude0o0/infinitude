<?xml version="1.0"?>
<weather_forecast xmlns:atom="http://www.w3.org/2005/Atom" version="1.6">
  <atom:link rel="self" href="http://128.11.138.31/weather/[% zip %]/forecast"/>
  <atom:link rel="http://www.api.ing.carrier.com/rels/weather" href="http://128.11.138.31/weather/[% zip %]"/>
  <timestamp>[% dt.iso8601 %].01234Z</timestamp>
  <ping>[% forecast_ping || '240' %]</ping>
  [%- 
    SET statuses = [ 'Thunderstorms', 'Sleet', 'Rain and Sleet', 'Wintry Mix', 'Rain and Snow', 'Snow', 'Freezing Rain', 'Rain', 'Blizzard', 'Fog', 'Cloudy', 'Partly Cloudy', 'Mostly Cloudy', 'Sunny' ];
    SET lookup = {};
    FOREACH stat = statuses;
      SET status.$stat = loop.index;
      SET k = stat.replace('\s+','').lower;
      SET lookup.$k = loop.count;
    END;
    SET lookup.${'clear'} = lookup.sunny;
    SET lookup.${'athunderstorm'} = lookup.thunderstorms;
    SET lookup.${'thunderstorm'} = lookup.thunderstorms;

    MACRO status_id(string) BLOCK;
      lookup.${string.replace('\s+','').lower.replace('chanceof','')} || lookup.${string.replace('\s+','').lower};
    END;
    
    SET today = dt.set_time_zone( time_zone || 'America/New_York' ) ;
    CALL dt.set_hour(0).set_minute(0).set_second(0);
  -%]
  [% FOREACH i = [0 .. 5] %]
  [%  SET forecast = wunderground.forecast10day.simpleforecast.forecastday.$i; %]
  <day id="[% today.day_name %]">
    <timestamp>[% today %][% today.offset / 3600 %]:00</timestamp>
    <min_temp units="f">[% forecast.low.fahrenheit %]</min_temp>
    <max_temp units="f">[% forecast.high.fahrenheit %]</max_temp>
    <status_id>[% status_id(forecast.conditions || forecast.icon) %]</status_id>
    <status_message>[% forecast.conditions %]</status_message>
    <pop>[% forecast.pop || '--' %]</pop>
  </day>
  [% CALL today.add(days=>1) %]
  [% END %]
</weather_forecast>
