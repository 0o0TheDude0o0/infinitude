"use strict";function wsu(a){var b=window.location;return("https:"===b.protocol?"wss://":"ws://")+b.hostname+(80!==b.port&&443!==b.port?":"+b.port:"")+a}angular.module("infinitude",["ngCookies","ngResource","ngSanitize","ngRoute","yaru22.angular-timeago","angular-dialgauge"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/profiles",{templateUrl:"views/profiles.html",controller:"MainCtrl"}).when("/schedules",{templateUrl:"views/schedules.html",controller:"MainCtrl"}).when("/serial",{templateUrl:"views/serial.html",controller:"SerialCtrl"}).when("/about",{templateUrl:"views/about.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("infinitude").controller("MainCtrl",["$scope","$http","$interval","$location",function(a,b,c,d){a.debounce=0,a.carbus=a.carbus||{};var e=angular.fromJson(window.localStorage.getItem("infinitude"))||{},f=function(){a.debounce>0&&(a.debounce=a.debounce-1);var c=["systems","status","notifications","energy"];angular.forEach(c,function(c){b.get("/"+c+".json").success(function(b){var d=c;"systems"===d&&(d="system"),a[c]=e[c]=b[d][0]})}),window.localStorage.setItem("infinitude",angular.toJson(e))};a.$watch("systems",function(b,c){b!==c&&(a.debounce=a.debounce+1)},!0),f(),c(f,18e4),a.isActive=function(a){return a===d.path()},a.save=function(){console.log("saving systems structure"),b.post("/systems/infinitude",a.systems).success(function(){a.debounce=0}).error(function(){console.log("oh noes! save fail.")})}}]);var toHex=function(a){for(var b="",c=0;c<a.length;c++)b+=" "+("0"+a.charCodeAt(c).toString(16).toUpperCase()).substr(-2,2);return b},serial;angular.module("infinitude").filter("markDiff",function(){return function(a,b){if(!b)return a;for(var c=!1,d="",e=0;e<a.length;e++)a.charCodeAt(e)!==b.charCodeAt(e)&&c===!1&&(c=!0,d+='<span class="diff">'),a.charCodeAt(e)===b.charCodeAt(e)&&c===!0&&(c=!1,d+="</span>"),d+=a.substr(e,1);return c&&(d+="</span>"),d}}).filter("subStr",function(){return function(a,b,c){return a?a.substr(b,c):""}}).filter("strings",function(){return function(a,b){b=b||4;for(var c=0,d=!1,e="",f="",g=0;g<a.length;g++)0===a.charCodeAt(g)&&d&&(f+=e+"\n"),a.charCodeAt(g)>=32&&a.charCodeAt(g)<=127?(e+=a.substr(g,1),c+=1,c>=b&&(d=!0)):(c=0,d=!1,e="");return f}}).filter("toHex",function(){return toHex}).controller("SerialCtrl",["$scope","$rootScope",function(a,b){a.rawSerial="Loading",a.frames=[],a.state=angular.fromJson(window.localStorage.getItem("infinitude-serial-state"))||{},serial=serial||new WebSocket(wsu("/serial")),serial.onopen=function(){console.log("Socket open")},serial.onclose=function(){console.log("Socket closed")},serial.onmessage=function(c){var d=angular.fromJson(c.data),e=new jDataView(d.data);if(b.carbus=b.carbus||{},b.history=b.history||angular.fromJson(window.localStorage.getItem("tmpdat"))||{},d.Function.match(/write|reply/)){var f=toHex(d.data.substring(0,3)),g=d.Function+d.SrcClass+d.DstClass+f,h=function(a,c){b.history[a]=b.history[a]||[{key:a,values:[]}],c=b.carbus[a],b.history[a][0].values.push([d.timestamp,c]),b.history[a][0].values.length>500&&b.history[a][0].values.shift(),window.localStorage.setItem("tmpdat",angular.toJson(b.history))};"FanCoil"===d.SrcClass&&(f.match(/00 03 06/)&&(b.carbus.blowerRPM=e.getInt16(4),h("blowerRPM")),f.match(/00 03 16/)&&(b.carbus.airflowCFM=e.getInt16(7),h("airflowCFM"))),d.SrcClass.match(/HeatPump/)&&f.match(/00 3E 01/)&&(b.carbus.outsideTemp=e.getInt16(3)/16,b.carbus.coilTemp=e.getInt16(5)/16,h("coilTemp"),h("outsideTemp"));var i=a.state[g]||d;i=i.data,a.state[g]=a.state[g]||{},angular.extend(a.state[g],d),a.state[g].history=a.state[g].history||[],i!==d.data&&a.state[g].history.unshift(i),a.state[g].history.length>9&&a.state[g].history.pop(),window.localStorage.setItem("infinitude-serial-state",angular.toJson(a.state))}a.frames.push(d),a.frames.length>9&&a.frames.shift(),a.$apply()}}]);